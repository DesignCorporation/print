name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRINT_SERVER_HOST }}
          username: ${{ secrets.PRINT_SERVER_USER }}
          key: ${{ secrets.PRINT_DEPLOY_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ [$(date)] –ù–∞—á–∏–Ω–∞—é production deploy –¥–ª—è Print DesignCorp..."

            PROD_DIR="/opt/print-designcorp"
            BACKUP_DIR="/opt/print-designcorp-backup"
            SERVICE_NAME="print-designcorp"

            # 1. Backup
            if [ -d "$PROD_DIR" ]; then
              rm -rf "$BACKUP_DIR"
              cp -r "$PROD_DIR" "$BACKUP_DIR"
              echo "‚úÖ Backup —Å–æ–∑–¥–∞–Ω"
            fi

            # 2. Git pull
            cd "$PROD_DIR"
            git fetch origin main
            git reset --hard origin/main
            echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω"

            # 3. Install deps
            npm ci --production=false --legacy-peer-deps
            echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

            # 4. Prisma generate
            npx prisma generate
            echo "‚úÖ Prisma client –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"

            # 4.5. Prisma migrate
            npx prisma migrate deploy
            echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"

            # 5. Build
            npm run build
            echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω"

            # 6. Restart service
            systemctl restart "$SERVICE_NAME"
            sleep 3
            echo "‚úÖ –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"

            # 7. Healthcheck - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–∏—Å
            sleep 5
            if ! systemctl is-active --quiet "$SERVICE_NAME"; then
              echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –æ—Ç–∫–∞—Ç—ã–≤–∞—é..."
              rm -rf "$PROD_DIR"
              cp -r "$BACKUP_DIR" "$PROD_DIR"
              systemctl restart "$SERVICE_NAME"
              exit 1
            fi

            # 7.5. Healthcheck - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ë–î endpoint
            if ! curl -f -s https://print.designcorp.eu/api/health > /dev/null 2>&1; then
              echo "‚ö†Ô∏è  Health endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
              echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: systemctl status $SERVICE_NAME"
            else
              echo "‚úÖ Health endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç"
            fi

            echo "‚úÖ Deploy —É—Å–ø–µ—à–µ–Ω! $(date)"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRINT_SERVER_HOST }}
          username: ${{ secrets.PRINT_SERVER_USER }}
          key: ${{ secrets.PRINT_DEPLOY_SSH_KEY }}
          script: |
            echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞:"
            systemctl status print-designcorp --no-pager | head -10
            echo ""
            echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:"
            curl -s -I https://print.designcorp.eu | head -5
